<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ”Ğ¾Ñ€Ğ¾Ğ³Ğ° Ğ´Ğ¾ Ğ¾Ñ‚ĞµĞ»Ñ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #1a1a2e;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-family: 'Press Start 2P', monospace;
  }
  canvas {
    display: block;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    cursor: pointer;
    max-width: 100vw;
    max-height: 100vh;
  }
</style>
</head>
<body>
<canvas id="game" width="800" height="450"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const W = 800, H = 450;
const GROUND_Y = 360;
const GRAVITY = 0.6;
const JUMP_FORCE = -13;
const PLAYER_SPEED = 3;
const WORLD_WIDTH = 3200;

const C = {
  purple:  '#6B2FA0',
  purpleL: '#9B4FD0',
  yellow:  '#FFD700',
  yellowD: '#E8A800',
  white:   '#FFFFFF',
  black:   '#1A0A2E',
  grey:    '#A0A0A0',
};

// â”€â”€â”€ Ğ¡Ğ¿Ñ€Ğ°Ğ¹Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const imgs = {};
const SPRITE_DIR = 'Assetes2d/';
const toLoad = ['walking','jumping','hotel','flag','background','ground','platform','rock','hero'];
let loadedCount = 0;
let allLoaded = false;

toLoad.forEach(name => {
  const img = new Image();
  img.src = SPRITE_DIR + name + '.png';
  img.onload = () => { loadedCount++; if (loadedCount === toLoad.length) allLoaded = true; };
  img.onerror = () => { loadedCount++; if (loadedCount === toLoad.length) allLoaded = true; };
  imgs[name] = img;
});

// â”€â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = 'start';
let camera = 0;
let animTick = 0;

const player = {
  x: 80, y: GROUND_Y - 72,
  vy: 0, onGround: true,
  frame: 0, frameTimer: 0,
};

// Ğ¡Ğ¿Ñ€Ğ°Ğ¹Ñ‚ walking: 4 ĞºĞ°Ğ´Ñ€Ğ° Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ, ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ 384Ã—1024 (Ğ¸Ğ· 1536Ã—1024)
// ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ~60% ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹ Ğ¸ ~70% Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹ ĞºĞ°Ğ´Ñ€Ğ° (Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ â€” Ğ¿Ğ¾Ğ»Ñ)
const WALK_FRAMES = 4;
const WALK_FRAME_W = 1536 / WALK_FRAMES; // 384 â€” Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ´Ñ€
const WALK_FRAME_H = 1024;
// Crop: Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ Ğ² Ñ†ĞµĞ½Ñ‚Ñ€Ğµ ĞºĞ°Ğ´Ñ€Ğ°, Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ~55% ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹ Ğ¸ ~65% Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹
const WALK_CROP_X = Math.round(WALK_FRAME_W * 0.18);
const WALK_CROP_Y = Math.round(WALK_FRAME_H * 0.18);
const WALK_CROP_W = Math.round(WALK_FRAME_W * 0.70);
const WALK_CROP_H = Math.round(WALK_FRAME_H * 0.70);
// Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° Ğ²Ñ‹ÑĞ¾Ñ‚Ğ¾Ğ¹ 90px
const HERO_H = 90;
const HERO_W = Math.round(HERO_H * (WALK_CROP_W / WALK_CROP_H));

// Ğ¤Ğ»Ğ°Ğ³: 2 ĞºĞ°Ğ´Ñ€Ğ° Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ â€” Ñ„Ğ»Ğ°Ğ³ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ~70% ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹, ~80% Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹
const FLAG_FRAMES = 2;
const FLAG_FRAME_W = 1536 / FLAG_FRAMES; // 768
const FLAG_FRAME_H = 1024;
// Crop Ñ„Ğ»Ğ°Ğ³Ğ° (Ñ„Ğ»Ğ°Ğ³ + ÑˆÑ‚Ğ¾Ğº Ğ¿Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ñƒ)
const FLAG_CROP_X = Math.round(FLAG_FRAME_W * 0.12);
const FLAG_CROP_Y = Math.round(FLAG_FRAME_H * 0.05);
const FLAG_CROP_W = Math.round(FLAG_FRAME_W * 0.75);
const FLAG_CROP_H = Math.round(FLAG_FRAME_H * 0.88);
const FLAG_H = 180;
const FLAG_W = Math.round(FLAG_H * (FLAG_CROP_W / FLAG_CROP_H));

// ĞÑ‚ĞµĞ»ÑŒ â€” Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ²Ñ‹ÑĞ¾Ñ‚Ğ¾Ğ¹ 240px
const HOTEL_H = 240;
const HOTEL_W = Math.round(HOTEL_H * (1536 / 1024));

// ĞšĞ°Ğ¼ĞµĞ½ÑŒ â€” ÑĞ¿Ñ€Ğ°Ğ¹Ñ‚ Ñ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸, crop Ñ†ĞµĞ½Ñ‚Ñ€ ~60%
const ROCK_SRC_PAD = 0.20; // Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹
const ROCK_CROP_X = Math.round(1536 * ROCK_SRC_PAD);
const ROCK_CROP_Y = Math.round(1024 * ROCK_SRC_PAD);
const ROCK_CROP_W = Math.round(1536 * (1 - ROCK_SRC_PAD * 2));
const ROCK_CROP_H = Math.round(1024 * (1 - ROCK_SRC_PAD * 2));
const ROCK_H = 70;
const ROCK_W = Math.round(ROCK_H * (ROCK_CROP_W / ROCK_CROP_H));

// Ğ—ĞµĞ¼Ğ»Ñ: ÑĞ¿Ñ€Ğ°Ğ¹Ñ‚ Ñ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸ ~20% Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹, crop Ñ†ĞµĞ½Ñ‚Ñ€
const GND_CROP_X = Math.round(1536 * 0.22);
const GND_CROP_Y = Math.round(1024 * 0.15);
const GND_CROP_W = Math.round(1536 * 0.56);
const GND_CROP_H = Math.round(1024 * 0.70);
const GROUND_TILE = 56; // Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ğ°Ğ¹Ğ»Ğ° Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½Ğµ

// Ğ¤Ğ¾Ğ½: Ğ¾Ğ±Ñ€ĞµĞ·Ğ°ĞµĞ¼ Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğµ ~12% (Ğ¿Ğ¾Ğ»Ğ¾ÑĞ° Ñ‚Ñ€Ğ°Ğ²Ñ‹) â€” Ñ€Ğ¸ÑÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ĞµĞ±Ğ¾+Ğ³Ğ¾Ñ€Ñ‹
const BG_CROP_H_FRAC = 0.88; // Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğµ 88% Ñ„Ğ¾Ğ½Ğ°

// ĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°: crop Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ ~60% ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹, ~40% Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹
const PLAT_CROP_X = Math.round(1536 * 0.18);
const PLAT_CROP_Y = Math.round(1024 * 0.32);
const PLAT_CROP_W = Math.round(1536 * 0.64);
const PLAT_CROP_H = Math.round(1024 * 0.36);
const PLAT_H = 32;
const PLAT_W = 160;

const FLAG_X = 2700;
const HOTEL_X = 2750;
const WIN_X = FLAG_X + 80;

const platforms = [
  { x: 420,  y: GROUND_Y - 70,  w: PLAT_W },
  { x: 720,  y: GROUND_Y - 90,  w: PLAT_W },
  { x: 1100, y: GROUND_Y - 80,  w: PLAT_W },
  { x: 1500, y: GROUND_Y - 100, w: PLAT_W },
  { x: 1900, y: GROUND_Y - 75,  w: PLAT_W },
  { x: 2300, y: GROUND_Y - 90,  w: PLAT_W },
];

const obstacles = [
  { x: 580,  y: GROUND_Y - ROCK_H + 10 },
  { x: 980,  y: GROUND_Y - ROCK_H + 10 },
  { x: 1380, y: GROUND_Y - ROCK_H + 10 },
  { x: 1780, y: GROUND_Y - ROCK_H + 10 },
  { x: 2150, y: GROUND_Y - ROCK_H + 10 },
];

// â”€â”€â”€ Ğ¡Ğ±Ñ€Ğ¾Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetGame() {
  player.x = 80; player.y = GROUND_Y - HERO_H;
  player.vy = 0; player.onGround = true;
  player.frame = 0; camera = 0;
  state = 'play';
}

// â”€â”€â”€ Ğ’Ğ²Ğ¾Ğ´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('keydown', e => {
  if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); handleJump(); }
});
canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const cx = (e.clientX - rect.left) * (W / rect.width);
  const cy = (e.clientY - rect.top)  * (H / rect.height);
  if (state === 'start') {
    if (cx > 270 && cx < 530 && cy > 242 && cy < 294) resetGame();
  } else if (state === 'play') {
    handleJump();
  } else if (state === 'win') {
    if (cx > 270 && cx < 530 && cy > 330 && cy < 380) resetGame();
  }
});
function handleJump() {
  if (state === 'start') { resetGame(); return; }
  if (state === 'play' && player.onGround) {
    player.vy = JUMP_FORCE;
    player.onGround = false;
  }
}

// â”€â”€â”€ Ğ¤Ğ¸Ğ·Ğ¸ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateGame() {
  animTick++;
  if (state !== 'play') return;

  player.x += PLAYER_SPEED;
  player.vy += GRAVITY;
  player.y += player.vy;

  if (player.y >= GROUND_Y - HERO_H) {
    player.y = GROUND_Y - HERO_H; player.vy = 0; player.onGround = true;
  }

  for (const p of platforms) {
    const ph = PLAT_H;
    if (player.x + HERO_W > p.x && player.x < p.x + p.w &&
        player.y + HERO_H >= p.y && player.y + HERO_H <= p.y + ph + 10 &&
        player.vy >= 0) {
      player.y = p.y - HERO_H; player.vy = 0; player.onGround = true;
    }
  }

  player.frameTimer++;
  if (player.frameTimer > 7) { player.frame = (player.frame + 1) % WALK_FRAMES; player.frameTimer = 0; }

  const targetCam = player.x - 150;
  camera += (targetCam - camera) * 0.12;
  camera = Math.max(0, Math.min(WORLD_WIDTH - W, camera));

  if (player.x > WIN_X) state = 'win';
}

// â”€â”€â”€ Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ñ€Ğ¸ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function px(x, y, w, h, color) { ctx.fillStyle = color; ctx.fillRect(x, y, w, h); }

function drawPixelText(text, x, y, size, color, align = 'center') {
  ctx.font = `${size}px "Press Start 2P"`;
  ctx.textAlign = align;
  ctx.fillStyle = C.black;
  ctx.fillText(text, x + 2, y + 2);
  ctx.fillStyle = color;
  ctx.fillText(text, x, y);
}

// â”€â”€â”€ Ğ¤Ğ¾Ğ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBackground(camX) {
  if (!imgs.background.complete || imgs.background.naturalWidth === 0) {
    const g = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
    g.addColorStop(0, '#FFD700'); g.addColorStop(1, '#FFE880');
    ctx.fillStyle = g; ctx.fillRect(0, 0, W, GROUND_Y);
    return;
  }
  const imgW = imgs.background.naturalWidth;   // 1536
  const imgH = imgs.background.naturalHeight;  // 1024
  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğµ BG_CROP_H_FRAC (Ğ±ĞµĞ· Ğ¿Ğ¾Ğ»Ğ¾ÑÑ‹ Ñ‚Ñ€Ğ°Ğ²Ñ‹ Ğ²Ğ½Ğ¸Ğ·Ñƒ)
  const srcH = Math.round(imgH * BG_CROP_H_FRAC);
  // Ğ Ğ°ÑÑ‚ÑĞ³Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° Ğ²ÑÑ ÑˆĞ¸Ñ€Ğ¸Ğ½Ñƒ ÑĞºÑ€Ğ°Ğ½Ğ°, Ğ²Ñ‹ÑĞ¾Ñ‚Ğ° â€” Ğ´Ğ¾ GROUND_Y
  const drawW = W;
  const drawH = GROUND_Y;
  // ĞŸĞ°Ñ€Ğ°Ğ»Ğ»Ğ°ĞºÑ: ÑĞ´Ğ²Ğ¸Ğ³ Ğ½Ğ° 0â€¦imgW Ğ¿Ğ¾ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»Ğ¸
  const parallax = (camX * 0.25) % imgW;
  // Ğ Ğ¸ÑÑƒĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· clip src Ğ¿Ğ¾ X: [parallax .. parallax+imgW] -> [0..W]
  // ĞŸÑ€Ğ¾Ñ‰Ğµ: Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ¾Ğ½ Ğ´Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¹ ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹ Ğ¸ Ñ‚Ğ°Ğ¹Ğ»Ğ¸Ğ¼
  const scaledW = Math.round(drawH * (imgW / srcH)); // ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° Ğ¿Ñ€Ğ¸ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ²Ñ‹ÑĞ¾Ñ‚Ğµ
  const offsetX = -(parallax * scaledW / imgW) % scaledW;
  for (let x = offsetX - scaledW; x < W + scaledW; x += scaledW) {
    ctx.drawImage(imgs.background,
      0, 0, imgW, srcH,           // src: Ğ²ĞµÑÑŒ width, Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğµ 88% Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹
      Math.round(x), 0, scaledW, drawH); // dst
  }
}

// â”€â”€â”€ Ğ—ĞµĞ¼Ğ»Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGround(camX) {
  // Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ÑÑ Ğ·ĞµĞ¼Ğ»Ñ ĞºĞ¾Ñ€Ğ¸Ñ‡Ğ½ĞµĞ²Ñ‹Ğ¼
  px(0, GROUND_Y, W, H - GROUND_Y, '#6B3A1E');

  const startX = Math.floor(camX / GROUND_TILE) * GROUND_TILE - camX % GROUND_TILE;
  if (imgs.ground.complete && imgs.ground.naturalWidth > 0) {
    // Ğ Ğ¸ÑÑƒĞµĞ¼ Ñ€ÑĞ´ Ñ‚Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¿Ğ¾ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¼Ñƒ ĞºÑ€Ğ°Ñ Ğ·ĞµĞ¼Ğ»Ğ¸
    for (let x = startX - GROUND_TILE; x < W + GROUND_TILE; x += GROUND_TILE) {
      ctx.drawImage(imgs.ground,
        GND_CROP_X, GND_CROP_Y, GND_CROP_W, GND_CROP_H,  // crop Ñ†ĞµĞ½Ñ‚Ñ€ ÑĞ¿Ñ€Ğ°Ğ¹Ñ‚Ğ°
        Math.round(x), GROUND_Y - 10, GROUND_TILE, GROUND_TILE + 10);
    }
  }
}

// â”€â”€â”€ ĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPlatform(p, camX) {
  const sx = Math.round(p.x - camX);
  if (sx > W + p.w || sx < -p.w) return;
  if (imgs.platform.complete && imgs.platform.naturalWidth > 0) {
    ctx.drawImage(imgs.platform,
      PLAT_CROP_X, PLAT_CROP_Y, PLAT_CROP_W, PLAT_CROP_H,
      sx, p.y, p.w, PLAT_H);
  } else {
    px(sx, p.y, p.w, PLAT_H, C.purple);
    px(sx, p.y, p.w, 6, C.yellow);
  }
}

// â”€â”€â”€ ĞšĞ°Ğ¼ĞµĞ½ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawRock(o, camX) {
  const sx = Math.round(o.x - camX);
  if (sx > W + ROCK_W || sx < -ROCK_W) return;
  if (imgs.rock.complete && imgs.rock.naturalWidth > 0) {
    ctx.drawImage(imgs.rock,
      ROCK_CROP_X, ROCK_CROP_Y, ROCK_CROP_W, ROCK_CROP_H,
      sx - ROCK_W / 2, o.y, ROCK_W, ROCK_H);
  } else {
    px(sx, o.y, ROCK_W, ROCK_H, '#808080');
  }
}

// â”€â”€â”€ Ğ¤Ğ»Ğ°Ğ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawFlag(camX) {
  const sx = Math.round(FLAG_X - camX);
  if (sx > W + FLAG_W || sx < -FLAG_W) return;
  const frame = Math.floor(animTick / 14) % FLAG_FRAMES;
  if (imgs.flag.complete && imgs.flag.naturalWidth > 0) {
    ctx.drawImage(imgs.flag,
      frame * FLAG_FRAME_W + FLAG_CROP_X, FLAG_CROP_Y, FLAG_CROP_W, FLAG_CROP_H,
      sx - FLAG_W / 2, GROUND_Y - FLAG_H, FLAG_W, FLAG_H);
  } else {
    px(sx + 4, GROUND_Y - 120, 4, 120, '#4A2A0E');
    px(sx + 8, GROUND_Y - 118, 40, 30, C.yellow);
  }
}

// â”€â”€â”€ ĞÑ‚ĞµĞ»ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawHotel(camX) {
  const sx = Math.round(HOTEL_X - camX);
  if (sx > W + HOTEL_W || sx < -HOTEL_W) return;
  if (imgs.hotel.complete && imgs.hotel.naturalWidth > 0) {
    ctx.drawImage(imgs.hotel, sx - HOTEL_W / 2, GROUND_Y - HOTEL_H, HOTEL_W, HOTEL_H);
  } else {
    px(sx, GROUND_Y - 200, 160, 200, C.purple);
  }
}

// â”€â”€â”€ ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPlayer(x, y, frame, onGround) {
  x = Math.round(x); y = Math.round(y);
  // Ñ‚ĞµĞ½ÑŒ
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.beginPath();
  ctx.ellipse(x + HERO_W / 2, GROUND_Y - 2, HERO_W * 0.6, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  if (!onGround && imgs.jumping.complete && imgs.jumping.naturalWidth > 0) {
    // ĞŸÑ€Ñ‹Ğ¶Ğ¾Ğº: Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ ÑĞ¼ĞµÑ‰Ñ‘Ğ½ Ğ²Ğ¿Ñ€Ğ°Ğ²Ğ¾-Ğ²Ğ½Ğ¸Ğ· Ğ¾Ñ‚ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°, crop ~50% ÑˆĞ¸Ñ€Ğ¸Ğ½Ñ‹ Ñ†ĞµĞ½Ñ‚Ñ€
    const jW = imgs.jumping.naturalWidth, jH = imgs.jumping.naturalHeight;
    const jCropX = Math.round(jW * 0.28);
    const jCropY = Math.round(jH * 0.05);
    const jCropW = Math.round(jW * 0.48);
    const jCropH = Math.round(jH * 0.88);
    const jDrawH = HERO_H;
    const jDrawW = Math.round(jDrawH * (jCropW / jCropH));
    ctx.drawImage(imgs.jumping, jCropX, jCropY, jCropW, jCropH, x, y, jDrawW, jDrawH);
  } else if (imgs.walking.complete && imgs.walking.naturalWidth > 0) {
    ctx.drawImage(imgs.walking,
      frame * WALK_FRAME_W + WALK_CROP_X, WALK_CROP_Y, WALK_CROP_W, WALK_CROP_H,
      x, y, HERO_W, HERO_H);
  } else {
    // fallback Ğ¿Ñ€ÑĞ¼Ğ¾ÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸Ğº
    px(x, y, HERO_W, HERO_H, C.purple);
  }
}

// â”€â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawButton(bx, by, bw, bh, label, size) {
  px(bx, by, bw, bh, C.black);
  px(bx + 3, by + 3, bw - 6, bh - 6, C.purple);
  px(bx + 3, by + 3, bw - 6, 6, C.purpleL);
  ctx.setLineDash([6, 4]);
  ctx.strokeStyle = C.yellow;
  ctx.lineWidth = 2;
  ctx.strokeRect(bx + 6, by + 6, bw - 12, bh - 12);
  ctx.setLineDash([]);
  drawPixelText(label, bx + bw / 2, by + bh / 2 + size / 2 - 2, size, C.yellow);
}

// â”€â”€â”€ Ğ¡Ğ¢ĞĞ Ğ¢-Ğ­ĞšĞ ĞĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawStartScreen() {
  drawBackground(0);
  drawGround(0);

  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  ctx.fillRect(0, 0, W, H);

  // Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ñ‡Ğ½Ğ°Ñ Ñ€Ğ°Ğ¼ĞºĞ°
  px(140, 68, 520, 140, C.black);
  px(144, 72, 512, 132, C.purple);
  px(144, 72, 512, 8, C.purpleL);

  drawPixelText('Ğ­ĞŸĞ˜Ğ§Ğ•Ğ¡ĞšĞĞ•', W / 2, 118, 26, C.yellow);
  drawPixelText('ĞŸĞ Ğ˜ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ•', W / 2, 158, 20, C.yellow);
  drawPixelText('Ğ”Ğ¾Ñ€Ğ¾Ğ³Ğ° Ğ´Ğ¾ Ğ¾Ñ‚ĞµĞ»Ñ', W / 2, 196, 12, C.white);

  drawButton(270, 224, 260, 52, 'Ğ˜Ğ“Ğ ĞĞ¢Ğ¬', 20);

  drawPixelText('ĞŸĞ ĞĞ‘Ğ•Ğ› / Ğ¢ĞĞŸ = Ğ¿Ñ€Ñ‹Ğ¶Ğ¾Ğº', W / 2, 314, 9, C.white);

  // Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
  drawPlayer(100, GROUND_Y - HERO_H, Math.floor(animTick / 8) % WALK_FRAMES, true);

  // Ğ¾Ñ‚ĞµĞ»ÑŒ ÑĞ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
  if (imgs.hotel.complete && imgs.hotel.naturalWidth > 0) {
    const hw = HOTEL_W * 0.55, hh = HOTEL_H * 0.55;
    ctx.drawImage(imgs.hotel, W - hw + 20, GROUND_Y - hh, hw, hh);
  }
}

// â”€â”€â”€ Ğ˜Ğ“Ğ ĞĞ’ĞĞ™ Ğ­ĞšĞ ĞĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGameScreen() {
  drawBackground(camera);
  drawGround(camera);

  for (const p of platforms) drawPlatform(p, camera);
  for (const o of obstacles) drawRock(o, camera);

  drawFlag(camera);
  drawHotel(camera);
  drawPlayer(player.x - camera, player.y, player.frame, player.onGround);

  // Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€
  const progress = Math.min(player.x / WIN_X, 1);
  px(20, 16, 200, 14, 'rgba(0,0,0,0.5)');
  px(22, 18, Math.floor(196 * progress), 10, C.purple);
  px(22, 18, Math.floor(196 * progress), 4, C.purpleL);
  ctx.fillStyle = C.white;
  ctx.font = '9px "Press Start 2P"';
  ctx.textAlign = 'left';
  ctx.fillText('ğŸ', 218, 29);
  ctx.fillText(`${Math.floor(progress * 100)}%`, 22, 44);
}

// â”€â”€â”€ Ğ­ĞšĞ ĞĞ ĞŸĞĞ‘Ğ•Ğ”Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawWinScreen() {
  // ÑÑ†ĞµĞ½Ğ° Ğ²Ğ²ĞµÑ€Ñ…Ñƒ
  drawBackground(WORLD_WIDTH * 0.8);
  drawGround(0);

  // Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ Ñƒ Ğ¾Ñ‚ĞµĞ»Ñ
  drawPlayer(W - 280, GROUND_Y - HERO_H, 0, true);

  // Ñ„Ğ»Ğ°Ğ³
  if (imgs.flag.complete && imgs.flag.naturalWidth > 0) {
    const fw = FLAG_W * 0.7, fh = FLAG_H * 0.7;
    ctx.drawImage(imgs.flag, 0, 0, FLAG_FRAME_W, FLAG_FRAME_H,
      W - 360, GROUND_Y - fh, fw, fh);
  }

  // Ğ¾Ñ‚ĞµĞ»ÑŒ
  if (imgs.hotel.complete && imgs.hotel.naturalWidth > 0) {
    const hw = HOTEL_W * 0.75, hh = HOTEL_H * 0.75;
    ctx.drawImage(imgs.hotel, W - hw - 20, GROUND_Y - hh, hw, hh);
  }

  // Ñ‚Ñ‘Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾Ğ²ĞµÑ€Ğ»ĞµĞ¹ ÑĞ½Ğ¸Ğ·Ñƒ
  const grad = ctx.createLinearGradient(0, GROUND_Y - 20, 0, H);
  grad.addColorStop(0, 'rgba(26,10,46,0)');
  grad.addColorStop(0.3, 'rgba(26,10,46,0.95)');
  grad.addColorStop(1, 'rgba(26,10,46,1)');
  ctx.fillStyle = grad;
  ctx.fillRect(0, GROUND_Y - 40, W, H - GROUND_Y + 40);

  // Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ±ĞµĞ´Ñ‹
  px(80, 190, 640, 200, C.black);
  px(84, 194, 632, 192, C.purple);
  px(84, 194, 632, 8, C.purpleL);

  drawPixelText('Ğ’Ğ« ĞŸĞĞ‘Ğ•Ğ”Ğ˜Ğ›Ğ˜!', W / 2, 228, 22, C.yellow);
  drawPixelText('Ğ’ĞĞ¨ ĞŸĞ ĞĞœĞĞšĞĞ”:', W / 2, 264, 11, C.white);

  // Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´
  px(220, 272, 360, 52, C.black);
  px(224, 276, 352, 44, '#2A1050');
  ctx.setLineDash([8, 5]);
  ctx.strokeStyle = C.yellow;
  ctx.lineWidth = 2;
  ctx.strokeRect(228, 280, 344, 36);
  ctx.setLineDash([]);
  drawPixelText('PIXEL20', W / 2, 305, 24, C.yellow);

  drawButton(270, 340, 260, 48, 'Ğ˜Ğ“Ğ ĞĞ¢Ğ¬ Ğ¡ĞĞĞ’Ğ', 13);

  drawPixelText('Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¸Ñ', W / 2, 418, 9, C.grey);
}

// â”€â”€â”€ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞĞ§ĞĞ«Ğ™ Ğ­ĞšĞ ĞĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawLoadingScreen() {
  px(0, 0, W, H, C.black);
  const progress = loadedCount / toLoad.length;
  px(200, H / 2 - 10, 400, 20, '#333');
  px(200, H / 2 - 10, Math.round(400 * progress), 20, C.purple);
  drawPixelText('Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ...', W / 2, H / 2 + 40, 14, C.yellow);
}

// â”€â”€â”€ Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ Ğ¦Ğ˜ĞšĞ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gameLoop() {
  ctx.clearRect(0, 0, W, H);

  if (!allLoaded) {
    drawLoadingScreen();
  } else {
    updateGame();
    if (state === 'start')     drawStartScreen();
    else if (state === 'play') drawGameScreen();
    else if (state === 'win')  drawWinScreen();
  }

  requestAnimationFrame(gameLoop);
}

function resize() {
  const scale = Math.min(window.innerWidth / W, window.innerHeight / H);
  canvas.style.width  = Math.floor(W * scale) + 'px';
  canvas.style.height = Math.floor(H * scale) + 'px';
}
window.addEventListener('resize', resize);
resize();

gameLoop();
</script>
</body>
</html>
